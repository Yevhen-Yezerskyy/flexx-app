{% extends "app_panel_client/base.html" %}

{% block panel_where %}Vertrag / Antrag auf Erwerb von Anleihen abschließen{% endblock %}

{% block panel_content %}
<script>
(function () {
  function initContractFinalizeModal() {
    var modal = document.getElementById("clientFinalizeContractModal");
    var panel = modal ? modal.querySelector("[data-client-finalize-panel]") : null;
    if (!modal || !panel) return;

    function openModal() {
      modal.classList.remove("hidden");
      modal.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";
    }

    function closeModal() {
      modal.classList.add("hidden");
      modal.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
    }

    if (modal.getAttribute("data-open-on-load") === "1") {
      openModal();
    }

    document.addEventListener("click", function (event) {
      var target = event.target;
      if (!(target instanceof Element)) return;

      if (target.closest("[data-client-finalize-close]")) {
        event.preventDefault();
        closeModal();
        return;
      }

      if (!modal.classList.contains("hidden") && !panel.contains(target) && target.closest("#clientFinalizeContractModal")) {
        closeModal();
      }
    });

    document.addEventListener("keydown", function (event) {
      if (event.key === "Escape" && !modal.classList.contains("hidden")) {
        event.preventDefault();
        closeModal();
      }
    });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initContractFinalizeModal);
  } else {
    initContractFinalizeModal();
  }
})();
</script>

<div class="flex items-center mb-10 mt-2">
  <div class="text-2xl">Vertrag / Antrag auf Erwerb von Anleihen abschließen</div>
</div>

<div class="bg-white border border-gray-400 rounded-md px-7 py-5">
  <div class="grid grid-cols-2 gap-8 items-start">
    <div class="flex flex-col gap-4">
      <div class="font-semibold">{{ contract.issue }}</div>
      <div class="grid grid-cols-[250px_minmax(0,1fr)] gap-x-2 gap-y-2 py-2">
        <div>Ausgabedatum:</div><div>{{ contract.issue.issue_date|date:"d.m.Y" }}</div>
        <div>Laufzeit:</div><div>{{ contract.issue.term_months }} Monate</div>
        <div>Volumen, €:</div><div>{{ contract.issue.issue_volume_display }}</div>
        <div>Preis pro Anleihe, €:</div><div>{{ contract.issue.bond_price_display }}</div>
        <div>Zinssatz:</div><div>{{ contract.issue.interest_rate }}%</div>
        <div>Mindestmenge:</div><div>{{ contract.issue.minimal_bonds_quantity_display }}</div>
      </div>
    </div>

    <div>
      {% if contract.issue.sorted_attachments %}
        {% for a in contract.issue.sorted_attachments %}
          <div class="mb-3 last:mb-0">
            {{ a.description|default:"—" }}<br>
            <a class="underline hover:text-[var(--accent)] transition"
               href="{{ a.file.url }}"
               title="{{ a.filename }}">
              {{ a.short_filename }}
            </a>
          </div>
        {% endfor %}
      {% else %}
        <span class="text-gray-500">Keine Dateien</span>
      {% endif %}
      <div class="mt-3">
        <a href="#"
           data-interest-modal-open
           data-issue-id="{{ contract.issue.id }}"
           class="underline hover:text-[var(--accent)] transition">
          Stückzinstabelle
        </a>
      </div>
    </div>
  </div>
</div>

<div class="mt-6 bg-white border border-gray-400 rounded-md px-7 py-5 flex flex-col gap-4">
  {% if errors %}
    <div class="bg-red-50 border border-red-200 text-red-700 rounded-md px-4 py-3">
      {% for e in errors %}
        <div>{{ e }}</div>
      {% endfor %}
    </div>
  {% endif %}

  {% if finalized_view %}
    <div class="grid grid-cols-2 gap-8 items-start">
      <div class="flex flex-col gap-4">
        <div class="font-semibold">Daten des Vertrags / Antrags</div>
        <div class="grid grid-cols-[250px_minmax(0,1fr)] gap-x-3 gap-y-2 py-2">
          <div>Vertragsdatum:</div><div>{{ form_contract_date|date:"d.m.Y" }}</div>
          <div>Zahlungsdatum:</div><div>{{ calc_result.settlement_date|date:"d.m.Y" }}</div>
          <div>Anzahl der Anleihen:</div><div>{{ contract_qty_display }}</div>
          <div>Nominalbetrag, €:</div><div>{{ calc_nominal_display }}</div>
          <div>Aufgelaufene Zinsen, €:</div><div>{{ calc_accrued_display }}</div>
          <div>Gesamtbetrag, €:</div><div>{{ calc_total_display }}</div>
        </div>
      </div>

      <div class="flex flex-col gap-4">
        <div class="font-semibold">Vertrag / Antrag</div>

        <div>Ihr Vertrag / Antrag auf Erwerb von Anleihen wurde erstellt.</div>

        <div>
          <a href="{{ contract_pdf_url }}"
             class="underline hover:text-[var(--accent)] transition"
             title="{{ contract_pdf_name }}">
            {{ contract_pdf_name }}
          </a>
        </div>

        <div>Ihr Vertrag / Antrag und die Emissionsunterlagen wurden Ihnen per E-Mail zugesandt.</div>

        <div>
          Sie können den Vertrag / Antrag ausdrucken, unterschreiben und uns die unterschriebene Version per E-Mail an service@flexxlager.com oder per Post an folgende Adresse senden:
        </div>

        <div>
          FleXXLager GmbH &amp; Co. KG<br>
          Weidenauer Straße 167<br>
          57076 Siegen
        </div>

        <div>Sie können den Vertrag jetzt elektronisch unterzeichnen.</div>

        <div class="flex items-center justify-end gap-4 pt-2">
          <a href="{% url 'panel_client_contracts_list' %}"
             class="w-56 rounded-md bg-gray-100 text-[var(--text)] py-3 hover:bg-gray-200 transition font-semibold text-center flex items-center justify-center">
            Abbrechen
          </a>
          <form method="post" action="{% url 'panel_client_contract_sign' %}" class="inline-flex">
            {% csrf_token %}
            <input type="hidden" name="action" value="open">
            <input type="hidden" name="contract_id" value="{{ contract.id }}">
            <button type="submit"
                    class="w-56 rounded-md bg-[var(--accent)] text-white py-3 hover:brightness-110 transition font-semibold text-center flex items-center justify-center">
              Jetzt unterzeichnen
            </button>
          </form>
        </div>
      </div>
    </div>
  {% else %}
    <form id="client-contract-application-form" method="post" class="w-full flex flex-col gap-4">
      {% csrf_token %}
      <input type="hidden" name="contract_id" value="{{ contract.id }}">

      <div>
        <div class="font-semibold">Berechnung der Einzahlsumme</div>
        <div class="mt-2">
          Der Gesamtbetrag (Kaufsumme), bestehend aus dem Nennbetrag und den aufgelaufenen Stückzinsen, wird auf Grundlage des Datums des Vertragsabschlusses zuzüglich 10 Bankarbeitstage berechnet. Der Gesamtbetrag (Kaufsumme) ist an diesem Tag zur Zahlung fällig.
        </div>
      </div>

      <div class="grid grid-cols-3 gap-4 items-end">
        <div class="flex flex-col gap-1">
          <label class="text-sm px-1">Vertragsdatum*</label>
          <input
            name="contract_date"
            type="date"
            value="{{ form_contract_date|date:'Y-m-d' }}"
            min="{{ today_date|date:'Y-m-d' }}"
            class="w-full h-10 border border-gray-400 rounded-md px-4 py-2 focus:outline-none bg-white"
          >
        </div>

        <div class="flex flex-col gap-1">
          <label class="text-sm px-1">Anzahl der Anleihen* (Minimum: {{ min_qty_display }})</label>
          <input
            name="bonds_quantity"
            type="number"
            min="{{ min_qty }}"
            step="1"
            value="{{ form_qty }}"
            class="w-full h-10 border border-gray-400 rounded-md px-4 py-2 focus:outline-none bg-white"
          >
        </div>

        <div class="flex items-end gap-3">
          <button
            type="submit"
            name="action"
            value="calc"
            class="w-full h-10 rounded-md bg-[var(--accent)] text-white hover:brightness-110 transition font-semibold text-center flex items-center justify-center"
          >
            Berechnen
          </button>
        </div>
      </div>

      {% if calc_result %}
        <div class="grid grid-cols-4 gap-4 pt-2">
          <div>
            <div class="bg-gray-100 rounded-md px-4 py-3">
              <div>Zahlungsdatum</div>
              <div class="font-semibold">{{ calc_result.settlement_date|date:"d.m.Y" }}</div>
            </div>
          </div>
          <div>
            <div class="bg-gray-100 rounded-md px-4 py-3">
              <div>Nominalbetrag, €</div>
              <div class="font-semibold">{{ calc_nominal_display }}</div>
            </div>
          </div>
          <div>
            <div class="bg-gray-100 rounded-md px-4 py-3">
              <div>Aufgelaufene Zinsen, €</div>
              <div class="font-semibold">{{ calc_accrued_display }}</div>
            </div>
          </div>
          <div>
            <div class="bg-gray-100 rounded-md px-4 py-3">
              <div>Gesamtbetrag, €</div>
              <div class="font-semibold">{{ calc_total_display }}</div>
            </div>
          </div>
        </div>

        <label class="flex items-start gap-2 pt-2">
          <input type="checkbox"
                 name="receipt_confirm_contract"
                 value="1"
                 form="client-contract-application-form"
                 class="mt-1 accent-[var(--accent)]"
                 {% if receipt_confirm_contract %}checked{% endif %}>
          <span>{{ consent_text }}</span>
        </label>
      {% endif %}

      <div class="flex items-center justify-end gap-4 pt-2">
        <a href="{% url 'panel_client_contracts_list' %}"
           class="w-56 rounded-md bg-gray-100 text-[var(--text)] py-3 hover:bg-gray-200 transition font-semibold text-center flex items-center justify-center">
          Abbrechen
        </a>
        {% if calc_result %}
          <button type="submit"
                  name="action"
                  value="prepare_finalize"
                  class="w-56 rounded-md bg-[var(--accent)] text-white py-3 hover:brightness-110 transition font-semibold text-center flex items-center justify-center">
            Vertrag / Antrag abschließen
          </button>
        {% endif %}
      </div>
    </form>
  {% endif %}
</div>

{% if not finalized_view and calc_result %}
  <div id="clientFinalizeContractModal"
       class="fixed inset-0 z-[9999] hidden"
       data-open-on-load="{% if show_finalize_modal %}1{% else %}0{% endif %}"
       aria-hidden="true">
    <div class="absolute inset-0 bg-black/50" data-client-finalize-close></div>

    <div class="absolute inset-0 flex items-center justify-center p-6 overflow-hidden">
      <div class="bg-white border border-[var(--text)] rounded-md shadow-lg w-[920px] max-w-[calc(100vw-48px)] max-h-[90vh] overflow-hidden flex flex-col pt-6 pb-6 pl-6 pr-[9px]" data-client-finalize-panel>
        <div class="shrink-0 flex items-start">
          <div class="flex-1">
            <div class="text-lg font-semibold">Vertrag / Antrag abschließen</div>
          </div>

          <div class="flex items-center gap-2 pr-[10px]">
            <button type="button"
                    data-client-finalize-close
                    class="underline hover:text-[var(--accent)] transition whitespace-nowrap">
              Schließen
            </button>
            <button type="button"
                    data-client-finalize-close
                    aria-label="Schließen"
                    class="h-8 w-8 inline-flex items-center justify-center rounded-md border border-[var(--text)] hover:bg-gray-100 transition">
              &#x2715;
            </button>
          </div>
        </div>

        <div class="mt-10 mb-10 pr-[10px] flex-1 min-h-0 overflow-y-auto">
          <div class="grid grid-cols-2 gap-8 items-start">
            <div class="flex flex-col gap-4">
              <div class="font-semibold">{{ contract.issue }}</div>
              <div class="grid grid-cols-[250px_minmax(0,1fr)] gap-x-3 gap-y-2 py-2">
                <div>Ausgabedatum:</div><div>{{ contract.issue.issue_date|date:"d.m.Y" }}</div>
                <div>Laufzeit:</div><div>{{ contract.issue.term_months }} Monate</div>
                <div>Volumen, €:</div><div>{{ contract.issue.issue_volume_display }}</div>
                <div>Preis pro Anleihe, €:</div><div>{{ contract.issue.bond_price_display }}</div>
                <div>Zinssatz:</div><div>{{ contract.issue.interest_rate }}%</div>
                <div>Mindestmenge:</div><div>{{ contract.issue.minimal_bonds_quantity_display }}</div>
              </div>
            </div>

            <div class="flex flex-col gap-4">
              <div class="font-semibold">Daten des Vertrags / Antrags</div>
              <div class="grid grid-cols-[250px_minmax(0,1fr)] gap-x-3 gap-y-2 py-2">
                <div>Vertragsdatum:</div><div>{{ form_contract_date|date:"d.m.Y" }}</div>
                <div>Zahlungsdatum:</div><div>{{ calc_result.settlement_date|date:"d.m.Y" }}</div>
                <div>Anzahl der Anleihen:</div><div>{{ contract_qty_display }}</div>
                <div>Nominalbetrag, €:</div><div>{{ calc_nominal_display }}</div>
                <div>Aufgelaufene Zinsen, €:</div><div>{{ calc_accrued_display }}</div>
                <div>Gesamtbetrag, €:</div><div>{{ calc_total_display }}</div>
              </div>
            </div>
          </div>
        </div>

        <div class="pt-6 pr-[10px] flex items-center justify-end gap-4">
          <button type="button"
                  data-client-finalize-close
                  class="w-56 rounded-md bg-gray-100 text-[var(--text)] py-3 hover:bg-gray-200 transition font-semibold text-center flex items-center justify-center">
            Abbrechen
          </button>
          <button type="submit"
                  form="client-contract-application-form"
                  name="action"
                  value="finalize"
                  class="w-56 rounded-md bg-[var(--accent)] text-white py-3 hover:brightness-110 transition font-semibold text-center flex items-center justify-center">
            Bestätigen
          </button>
        </div>
      </div>
    </div>
  </div>
{% endif %}
{% endblock %}
