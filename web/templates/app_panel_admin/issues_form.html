{% extends "app_panel_admin/base.html" %}
<!-- FILE: web/templates/app_panel_admin/issues_form.html  (обновлено — 2026-02-15)
     PURPOSE: Fix: date value не теряется при invalid POST (убран date-filter), decimal поля оставлены type=text (DE-запятая), общий стиль без изменений. -->
{% block panel_where %}Platzierungen{% endblock %}
{% block nav_issues_class %}text-[var(--accent)] font-semibold{% endblock %}

{% block panel_content %}

<div class="flex items-center mb-10 mt-2">
  <div class="text-2xl">
    {% if mode == "edit" %}Platzierung ändern{% else %}Neue Platzierung{% endif %}
  </div>
  <div class="flex-1"></div>
   <a href="{% url 'panel_admin_issues_list' %}" class="w-48 rounded-md bg-gray-50 border-2 border-white text-[var(--text)] py-3 hover:brightness-95 transition font-semibold text-center flex items-center justify-center">
    Zurück
  </a>
</div>

<form method="post" enctype="multipart/form-data" class="flex flex-col gap-6">
  {% csrf_token %}
  <div class="bg-white border border-[var(--accent)] rounded-md px-7 py-5 flex flex-col gap-4">
    <div>{{ form.active }}&nbsp;&nbsp;{{ form.active.label }}</div>

    <div class="flex flex-col">
      <label class="text-sm px-4">{{ form.title.label }}:</label>
      <input name="{{ form.title.name }}" value="{{ form.title.value|default:'' }}"
             type="text" placeholder="{{ form.title.label }}"
             class="border border-[var(--text)] rounded-md px-4 py-2 focus:outline-none">
      {% if form.title.errors %}<div class="text-sm text-red-600">{{ form.title.errors|join:", " }}</div>{% endif %}
    </div>

    <div class="grid grid-cols-5 gap-4">
      <div class="flex flex-col gap-1">
        <label class="text-sm px-4">{{ form.issue_date.label }}:</label>
        <input name="{{ form.issue_date.name }}" value="{{ form.issue_date.value|default:'' }}"
               type="date" placeholder="{{ form.issue_date.label }}"
               class="border border-[var(--text)] rounded-md px-4 py-2 focus:outline-none">
        {% if form.issue_date.errors %}<div class="text-sm text-red-600">{{ form.issue_date.errors|join:", " }}</div>{% endif %}
      </div>

      <div class="flex flex-col gap-1">
        <label class="text-sm px-4">{{ form.interest_rate.label }}:</label>
        <input name="{{ form.interest_rate.name }}" value="{{ form.interest_rate.value|default:'' }}"
               type="text" placeholder="{{ form.interest_rate.label }}"
               class="border border-[var(--text)] rounded-md px-4 py-2 focus:outline-none">
        {% if form.interest_rate.errors %}<div class="text-sm text-red-600">{{ form.interest_rate.errors|join:", " }}</div>{% endif %}
      </div>

      <div class="flex flex-col gap-1">
        <label class="text-sm px-4">{{ form.bond_price.label }}:</label>
        <input name="{{ form.bond_price.name }}" value="{{ form.bond_price.value|default:'' }}"
               type="text" placeholder="{{ form.bond_price.label }}"
               class="border border-[var(--text)] rounded-md px-4 py-2 focus:outline-none">
        {% if form.bond_price.errors %}<div class="text-sm text-red-600">{{ form.bond_price.errors|join:", " }}</div>{% endif %}
      </div>

      <div class="flex flex-col gap-1">
        <label class="text-sm px-4">{{ form.issue_volume.label }}:</label>
        <input name="{{ form.issue_volume.name }}" value="{{ form.issue_volume.value|default:'' }}"
               type="text" placeholder="{{ form.issue_volume.label }}"
               class="border border-[var(--text)] rounded-md px-4 py-2 focus:outline-none">
        {% if form.issue_volume.errors %}<div class="text-sm text-red-600">{{ form.issue_volume.errors|join:", " }}</div>{% endif %}
      </div>

      <div class="flex flex-col gap-1">
        <label class="text-sm px-4">{{ form.term_months.label }}:</label>
        <input name="{{ form.term_months.name }}" value="{{ form.term_months.value|default:'' }}"
               type="number" min="0" step="1" placeholder="{{ form.term_months.label }}"
               class="border border-[var(--text)] rounded-md px-4 py-2 focus:outline-none">
        {% if form.term_months.errors %}<div class="text-sm text-red-600">{{ form.term_months.errors|join:", " }}</div>{% endif %}
      </div>
    </div>
  </div>

  <div class="bg-white border border-[var(--accent)] rounded-md px-7 py-5 flex flex-col gap-4">
    <div class="text-xl mb-2">Dateien</div>

    <div class="flex flex-col gap-2" id="files-list">
      {% for a in attachments %}
        <div class="flex items-center gap-4 bg-gray-50 border border-gray-200 rounded-md px-4 py-3">
          <div class="flex-1">
            <div class="font-semibold">{{ a.filename }}</div>
            {% if a.description %}<div class="text-xs text-gray-500">{{ a.description }}</div>{% endif %}
          </div>
          <div class="text-sm">
            <a class="underline hover:text-[var(--accent)] transition" href="{{ a.file.url }}" target="_blank">Öffnen</a>
          </div>
        </div>
      {% empty %}
        <div class="text-sm text-gray-500">Keine Dateien.</div>
      {% endfor %}
    </div>

    <div class="flex items-center gap-3">
      <input type="file" name="files" multiple class="text-sm">
      <input type="text" name="files_description" placeholder="Beschreibung (optional)"
             class="border border-[var(--text)] rounded-md px-4 py-2 focus:outline-none flex-1">
    </div>

    <div id="new-files"></div>
  </div>

  <div class="bg-white border border-[var(--accent)] rounded-md px-7 py-5 flex flex-col gap-4">
    <div class="text-xl mb-2">Vertragstexte</div>

    <div class="flex flex-col gap-4">
      {% for f in contract_fields %}
        <div class="flex flex-col gap-1">
          <label class="text-sm px-4">{{ f.label }}:</label>
          <textarea name="contract__{{ f.key }}" rows="{{ f.rows }}"
                    class="border border-[var(--text)] rounded-md px-4 py-2 focus:outline-none">{{ f.value }}</textarea>
        </div>
      {% endfor %}
    </div>
  </div>

  <div class="flex items-center gap-4">
    <div class="flex-1"></div>

    <a href="{% url 'panel_admin_issues_list' %}"
       class="w-48 rounded-md bg-gray-50 border-2 border-white text-[var(--text)] py-3 hover:brightness-95 transition font-semibold text-center flex items-center justify-center">
      Abbrechen
    </a>

    <button type="submit"
            class="w-48 rounded-md bg-[var(--accent)] text-white py-3 hover:brightness-110 transition font-semibold">
      Speichern
    </button>
  </div>

</form>

{% endblock %}
