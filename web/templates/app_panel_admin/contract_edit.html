{% extends "app_panel_admin/base.html" %}
<!-- FILE: web/templates/app_panel_admin/contract_edit.html  (обновлено — 2026-02-16)
     PURPOSE: UI state machine:
       - mode=empty: only Berechnen
       - mode=calc: show results + Speichern (and hide PDF)
       - mode=saved: hide Speichern, show “PDF generieren”; re-calc switches back to mode=calc -->

{% block panel_where %}Vertrag bearbeiten{% endblock %}
{% block nav_contracts_class %}text-[var(--accent)] font-semibold{% endblock %}

{% block panel_content %}
<script>
function validateContractReceiptForSavePdf(btn) {
  const formEl = btn.form;
  if (!formEl) return true;
  const cb = formEl.querySelector('input[name="receipt_confirm_contract"]');
  if (!cb || !cb.checked) {
    alert("Bitte bestätigen Sie die Empfangsbestätigung.");
    return false;
  }
  return true;
}
</script>

<div class="flex items-center mb-8 mt-2">
  <div class="text-2xl">Vertrag bearbeiten</div>
  <div class="flex-1"></div>
  <div class="flex items-center justify-end gap-4">
    <a href="{% url 'panel_admin_clients' %}"
       class="w-72 rounded-md bg-gray-100 text-[var(--text)] py-3 hover:bg-gray-200 transition font-semibold text-center">
      Zurück zu Kunden
    </a>
    <a href="{% url 'panel_admin_contracts_list' %}"
       class="w-72 rounded-md bg-gray-100 text-[var(--text)] py-3 hover:bg-gray-200 transition font-semibold text-center">
      Zurück zu Verträgen
    </a>
  </div>
</div>

<div class="bg-white border border-gray-400 rounded-md px-7 py-5 flex flex-col gap-4">
  <div class="grid {% if tippgeber %}grid-cols-[minmax(0,1fr)_minmax(0,1fr)_minmax(0,1.5fr)_auto]{% else %}grid-cols-[minmax(0,1fr)_minmax(0,1.5fr)_auto]{% endif %} gap-4 items-start">
    <div>
      <div>Kunde:</div>
      <div class="font-semibold">{{ contract.client.first_name }} {{ contract.client.last_name }}</div>
      <div>
        <a href="mailto:{{ contract.client.email }}" class="underline hover:text-[var(--accent)] transition">{{ contract.client.email }}</a>
      </div>
    </div>

    {% if tippgeber %}
      <div>
        <div>Tippgeber:</div>
        <div>{{ tippgeber.first_name }} {{ tippgeber.last_name }}</div>
        <div>
          <a href="mailto:{{ tippgeber.email }}" class="underline hover:text-[var(--accent)] transition">{{ tippgeber.email }}</a>
        </div>
      </div>
    {% endif %}

    <div class="flex flex-col min-w-0">
      <div class="font-semibold">{{ contract.issue.title }}</div>
      <div class="grid grid-cols-[140px_minmax(0,1fr)] gap-x-2 py-1">
        <div>Ausgabedatum:</div><div>{{ contract.issue.issue_date|date:"d.m.Y" }}</div>
      </div>
      <div class="grid grid-cols-[140px_minmax(0,1fr)] gap-x-2 py-1">
        <div>Zinssatz:</div><div>{{ contract.issue.interest_rate }}%</div>
      </div>
      <div class="grid grid-cols-[140px_minmax(0,1fr)] gap-x-2 py-1">
        <div>Laufzeit:</div><div>{{ contract.issue.term_months }} Monate</div>
      </div>
      <div class="grid grid-cols-[140px_minmax(0,1fr)] gap-x-2 py-1">
        <div>Preis pro Anleihe, €:</div><div>{{ issue_bond_price_display }}</div>
      </div>
      <div class="grid grid-cols-[140px_minmax(0,1fr)] gap-x-2 py-1">
        <div>Volumen, €:</div><div>{{ issue_volume_display }}</div>
      </div>
    </div>

    <div>
      <a href="#"
         data-interest-modal-open
         data-issue-id="{{ contract.issue.id }}"
         class="underline hover:text-[var(--accent)] transition whitespace-nowrap">
        Stückzinstabelle
      </a>
    </div>
  </div>
</div>

<div class="mt-6 bg-white border border-gray-400 rounded-md px-7 py-5 flex flex-col gap-4">
  <div class="text-lg">Berechnung</div>

  {% if errors %}
    <div class="bg-red-50 border border-red-200 text-red-700 rounded-md px-4 py-3">
      {% for e in errors %}
        <div>{{ e }}</div>
      {% endfor %}
    </div>
  {% endif %}

  {% if ok_message %}
    <div class="bg-green-50 border border-green-200 text-green-700 rounded-md px-4 py-3">
      {{ ok_message }}
    </div>
  {% endif %}

  <form method="post" class="w-full flex flex-col gap-4">
    {% csrf_token %}

    <div class="grid grid-cols-3 gap-4 items-end">
      <div class="flex flex-col gap-1">
        <label class="text-sm px-1">Datum der Unterzeichnung*</label>
        <input
          name="contract_date"
          type="date"
          value="{{ form_contract_date|date:'Y-m-d' }}"
          class="w-full h-10 border border-gray-400 rounded-md px-4 py-2 focus:outline-none bg-white"
        >
      </div>

      <div class="flex flex-col gap-1">
        <label class="text-sm px-1">Anzahl der Anleihen* (Minimum: {{ min_qty_display }})</label>
        <input
          name="bonds_quantity"
          type="number"
          min="{{ min_qty }}"
          step="1"
          value="{{ form_qty }}"
          class="w-full h-10 border border-gray-400 rounded-md px-4 py-2 focus:outline-none bg-white"
        >
      </div>

      <div class="flex items-end gap-3">
        <button
          name="action"
          value="calc"
          class="w-full h-10 rounded-md bg-[var(--accent)] text-white hover:brightness-110 transition font-semibold text-center flex items-center justify-center"
        >
          Berechnen
        </button>

      </div>
    </div>

    {% if calc_result %}
      <div class="grid grid-cols-4 gap-4 pt-2">
        <div>
          <div class="bg-gray-100 rounded-md px-4 py-3">
            <div>Zahlungsfrist bis</div>
            <div class="font-semibold">{{ calc_result.settlement_date|date:"d.m.Y" }}</div>
          </div>
        </div>
        <div>
          <div class="bg-gray-100 rounded-md px-4 py-3">
            <div>Nominalbetrag, €</div>
            <div class="font-semibold">{{ calc_nominal_display }}</div>
          </div>
        </div>
        <div>
          <div class="bg-gray-100 rounded-md px-4 py-3">
            <div>Aufgelaufene Zinsen, €</div>
            <div class="font-semibold">{{ calc_accrued_display }}</div>
          </div>
        </div>
        <div>
          <div class="bg-gray-100 rounded-md px-4 py-3">
            <div>Gesamtbetrag, €</div>
            <div class="font-semibold">{{ calc_total_display }}</div>
          </div>
        </div>
      </div>
        {% if mode == "calc" and calc_result %}
          <input type="hidden" name="calc_settlement_date" value="{{ calc_result.settlement_date|date:'Y-m-d' }}">
          <input type="hidden" name="calc_nominal_amount" value="{{ calc_result.nominal_amount }}">
          <input type="hidden" name="calc_accrued_interest" value="{{ calc_result.accrued_interest }}">
          <input type="hidden" name="calc_total_amount" value="{{ calc_result.total_amount }}">
        {% endif %}
      <div class="pt-2">
        <div class="font-semibold">Berechnung der Einzahlsumme</div>
        <div class="mt-2">
          Die Einzahlsumme wird auf Grundlage des Datums der Unterzeichnung zuzüglich 10 Bankarbeitstage berechnet. Auf diesen Stichtag werden der Nennbetrag sowie die aufgelaufenen Stückzinsen ermittelt.
        </div>
        <div class="mt-2">
          Geht der Zahlungsbetrag vor oder nach diesem Termin ein, können die Stückzinsen auf Basis des tatsächlichen Zahlungseingangsdatums neu berechnet werden.
        </div>
        <label class="mt-3 flex items-start gap-2">
          <input type="checkbox" name="receipt_confirm_contract" value="1" class="mt-1 accent-[var(--accent)]" {% if receipt_confirm_contract %}checked{% endif %}>
          <span>
            <strong>Empfangsbestätigung.</strong> Ich bestätige, das Private Placement Memorandum und das Produktinformationsblatt der FleXXLager GmbH & Co. KG erhalten zu haben. Ich bestätige, die Informationen für den Verbraucher mit der dort enthaltenen Widerrufsbelehrung erhalten zu haben.
          </span>
        </label>
      </div>
      {% if mode == "calc" and calc_result %}
        <div class="pt-2 flex items-center justify-end">
          <button
            name="action"
            value="save_pdf"
            class="w-72 rounded-md bg-[var(--accent)] text-white py-3 hover:brightness-110 transition font-semibold text-center flex items-center justify-center"
            onclick="return validateContractReceiptForSavePdf(this);"
          >
            Verträge generieren
          </button>
        </div>
      {% endif %}
    {% endif %}
  </form>

  {% if mode != "calc" %}
  {% if saved_pdf_url or saved_dsgvo_pdf_url %}
    <div class="pt-2">
      <div class="flex items-start justify-between gap-4">
        <div class="min-w-0">
          <div class="font-semibold">Verträge:</div>
          {% if saved_pdf_url and saved_pdf_name %}
          <div>
            <a href="{{ saved_pdf_url }}" class="underline hover:text-[var(--accent)] transition">
              {{ saved_pdf_name }}
            </a>
          </div>
          {% endif %}
          {% if saved_dsgvo_pdf_url and saved_dsgvo_pdf_name %}
            <div class="mt-1">
              <a href="{{ saved_dsgvo_pdf_url }}" class="underline hover:text-[var(--accent)] transition">
                {{ saved_dsgvo_pdf_name }}
              </a>
            </div>
          {% endif %}
        </div>
        <div class="shrink-0 self-end flex justify-end">
          <a href="{% url 'panel_admin_contract_unterschreiben' contract.id %}"
             class="w-72 rounded-md bg-[var(--accent)] text-white py-3 hover:brightness-110 transition font-semibold text-center">
            Vertrag unterschreiben
          </a>
        </div>
      </div>
      <div class="mt-10 flex items-center justify-end gap-4 flex-wrap">
        <a href="{% url 'panel_admin_clients' %}"
           class="w-72 rounded-md bg-gray-100 text-[var(--text)] py-3 hover:bg-gray-200 transition font-semibold text-center">
          Zurück zu Kunden
        </a>
        <a href="{% url 'panel_admin_contracts_list' %}"
           class="w-72 rounded-md bg-gray-100 text-[var(--text)] py-3 hover:bg-gray-200 transition font-semibold text-center">
          Zurück zu Verträgen
        </a>
      </div>
    </div>
  {% endif %}
  {% endif %}
</div>

{% endblock %}
