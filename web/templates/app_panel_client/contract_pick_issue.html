{% extends "app_panel_client/base.html" %}
{% block panel_where %}Vertrag erstellen{% endblock %}
{% block nav_contract_create_class %}text-[var(--accent)] font-semibold{% endblock %}

{% block panel_content %}
<script>
function validateIssueReceipt(formEl) {
  const selected = formEl.querySelector('input[name="issue_id"]:checked');
  if (!selected) return false;
  const receipt = formEl.querySelector('input[name="receipt_confirm_' + selected.value + '"]');
  if (!receipt || !receipt.checked) {
    alert("Bitte bestätigen Sie die Empfangsbestätigung für die ausgewählte Emission.");
    return false;
  }
  return true;
}
</script>

<div class="flex items-center mb-8 mt-2">
  <div class="text-2xl">Vertrag erstellen</div>
  <div class="flex-1"></div>
  <a href="{% url 'panel_client_contract_create' %}"
     class="w-48 rounded-md bg-gray-100 border-2 border-white text-[var(--text)] py-3 hover:brightness-95 transition font-semibold text-center flex items-center justify-center">
    Zurück
  </a>
</div>

<div class="bg-white border border-gray-400 rounded-md px-7 py-5 flex flex-col gap-4">
  <div class="grid grid-cols-2 gap-4">
    <div>
      <div>Kunde:</div>
      <div class="font-semibold">{{ client.first_name }} {{ client.last_name }}</div>
      <div>
        <a href="mailto:{{ client.email }}" class="underline hover:text-[var(--accent)] transition">{{ client.email }}</a>
      </div>
    </div>
    <div></div>
  </div>

  <form method="post" class="flex flex-col gap-4" onsubmit="return validateIssueReceipt(this);">
    {% csrf_token %}

    <div class="bg-gray-100 border-2 border-white rounded-md p-4">
      <div class="font-semibold mb-2">Emission wählen</div>
      <div class="-mx-4 border-b-[3px] border-white mb-2"></div>
      {% if pick_error %}
        <div class="text-red-600 mb-2">{{ pick_error }}</div>
      {% endif %}

      {% if issues %}
        <div class="flex flex-col">
          {% for it in issues %}
            {% if not forloop.first %}
              <div class="-mx-4 border-b-[3px] border-white"></div>
            {% endif %}
            <label class="flex items-start gap-3 cursor-pointer w-full py-2">
              <input type="radio"
                     name="issue_id"
                     value="{{ it.id }}"
                     class="mt-1 accent-[var(--accent)]"
                     {% if selected_issue_id == it.id %}checked{% endif %}>
              <div class="w-full min-w-0">
                <div class="grid grid-cols-[minmax(0,0.65fr)_minmax(0,1.75fr)] gap-7 w-full items-start">
                  <div class="flex flex-col min-w-0">
                    <div class="font-semibold">{{ it.title }}</div>
                    <div class="flex flex-col min-w-0 pt-1">
                      <div class="grid grid-cols-[140px_minmax(0,1fr)] gap-x-2 py-1 pr-[10px]">
                        <div>Ausgabedatum:</div><div>{{ it.issue_date|date:"d.m.Y" }}</div>
                      </div>
                      <div class="grid grid-cols-[140px_minmax(0,1fr)] gap-x-2 py-1 pr-[10px]">
                        <div>Zinssatz:</div><div>{{ it.interest_rate }}%</div>
                      </div>
                      <div class="grid grid-cols-[140px_minmax(0,1fr)] gap-x-2 py-1 pr-[10px]">
                        <div>Laufzeit:</div><div>{{ it.term_months }} Monate</div>
                      </div>
                      <div class="grid grid-cols-[140px_minmax(0,1fr)] gap-x-2 py-1 pr-[10px]">
                        <div>Preis pro Anleihe, €:</div><div>{{ it.bond_price_display }}</div>
                      </div>
                      <div class="grid grid-cols-[140px_minmax(0,1fr)] gap-x-2 py-1 pr-[10px]">
                        <div>Volumen, €:</div><div>{{ it.issue_volume_display }}</div>
                      </div>
                      <div class="grid grid-cols-[140px_minmax(0,1fr)] gap-x-2 py-1 pr-[10px]">
                        <div>Mindestmenge:</div><div>{% if it.minimal_bonds_quantity %}{{ it.minimal_bonds_quantity }}{% else %}5000{% endif %}</div>
                      </div>
                    </div>
                  </div>
                  <div class="flex flex-col gap-0 w-full min-w-0 justify-start items-start self-start content-start pt-0 mt-0">
                    {% if it.attachments.all %}
                      {% for a in it.attachments.all %}
                        <div class="min-w-0 py-0.5">
                          {{ a.description|default:"Datei" }}:
                          <a href="{{ a.file.url }}" target="_blank" class="underline hover:text-[var(--accent)] transition" title="{{ a.filename }}">
                            {{ a.short_filename }}
                          </a>
                        </div>
                      {% endfor %}
                    {% else %}
                      <div class="text-gray-500">Keine Dateien</div>
                    {% endif %}
                    <div class="mt-2">
                      <a href="#"
                         data-interest-modal-open
                         data-issue-id="{{ it.id }}"
                         class="underline hover:text-[var(--accent)] transition">
                        Stückzinstabelle
                      </a>
                    </div>
                    <label class="mt-4 flex items-start gap-2">
                      <input type="checkbox" name="receipt_confirm_{{ it.id }}" value="1" class="mt-1 accent-[var(--accent)]" {% if selected_issue_id == it.id and receipt_confirm_selected %}checked{% endif %}>
                      <span>
                        <strong>Empfangsbestätigung.</strong> Ich bestätige, das Private Placement Memorandum und das Produktinformationsblatt der FleXXLager GmbH & Co. KG erhalten zu haben. Ich bestätige, die Informationen für den Verbraucher mit der dort enthaltenen Widerrufsbelehrung erhalten zu haben.
                      </span>
                    </label>
                  </div>
                </div>
              </div>
            </label>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-gray-600">Keine Emissionen vorhanden.</div>
      {% endif %}
    </div>

    <div class="flex items-center gap-4 justify-end">
      <a href="{% url 'panel_client_contract_create' %}"
         class="w-56 rounded-md bg-gray-100 text-[var(--text)] py-3 hover:bg-gray-200 transition font-semibold text-center">
        Abbrechen
      </a>

      <button type="submit"
              class="w-56 rounded-md bg-[var(--accent)] text-white py-3 hover:brightness-110 transition font-semibold"
              {% if not issues %}disabled{% endif %}>
        Vertrag erstellen
      </button>
    </div>
  </form>
</div>
{% endblock %}
