{% extends "app_panel_admin/base.html" %}
<!-- FILE: web/templates/app_panel_admin/issues_form.html  (обновлено — 2026-02-15)
     PURPOSE: Fix Emission edit: issue_date правильно подставляется (GET = date:'Y-m-d', POST = raw value), contract__ тексты снова выводятся из form (как было). -->
{% block panel_where %}Platzierungen{% endblock %}
{% block nav_issues_class %}text-[var(--accent)] font-semibold{% endblock %}

{% block panel_content %}

<div class="flex items-center mb-10 mt-2">
  <div class="text-2xl">
    {% if mode == "edit" %}Platzierung ändern{% else %}Neue Platzierung{% endif %}
  </div>
  <div class="flex-1"></div>
   <a href="{% url 'panel_admin_issues_list' %}" class="w-48 rounded-md bg-gray-50 border-2 border-white text-[var(--text)] py-3 hover:brightness-95 transition font-semibold text-center flex items-center justify-center">
    Zurück
  </a>
</div>

<form method="post" enctype="multipart/form-data" class="flex flex-col gap-6">
  {% csrf_token %}
  <div class="bg-white border border-[var(--accent)] rounded-md px-7 py-5 flex flex-col gap-4">
    <div>{{ form.active }}&nbsp;&nbsp;{{ form.active.label }}</div>

    <div class="flex flex-col">
      <label class="text-sm px-4">{{ form.title.label }}:</label>
      <input name="{{ form.title.name }}" value="{{ form.title.value|default:'' }}"
             type="text" placeholder="{{ form.title.label }}"
             class="border border-[var(--text)] rounded-md px-4 py-2 focus:outline-none">
          {% if form.title.errors %}<div class="text-sm text-red-600">{{ form.title.errors|join:", " }}</div>{% endif %}
    </div>

    <div class="grid grid-cols-5 gap-4">
      <div class="flex flex-col gap-1">
        <label class="text-sm px-4">{{ form.issue_date.label }}:</label>
        <input name="{{ form.issue_date.name }}"
               value="{% if form.is_bound %}{{ form.issue_date.value|default:'' }}{% else %}{{ form.issue_date.value|date:'Y-m-d' }}{% endif %}"
               type="date" placeholder="{{ form.issue_date.label }}"
               class="border border-[var(--text)] rounded-md px-4 py-2 focus:outline-none">
            {% if form.issue_date.errors %}<div class="text-sm text-red-600">{{ form.issue_date.errors|join:", " }}</div>{% endif %}
      </div>

      <div class="flex flex-col gap-1">
        <label class="text-sm px-4">{{ form.interest_rate.label }}:</label>
        <input name="{{ form.interest_rate.name }}" value="{{ form.interest_rate.value|default:'' }}"
               type="text" placeholder="{{ form.interest_rate.label }}"
               class="border border-[var(--text)] rounded-md px-4 py-2 focus:outline-none">
              {% if form.interest_rate.errors %}<div class="text-sm text-red-600">{{ form.interest_rate.errors|join:", " }}</div>{% endif %}
      </div>

      <div class="flex flex-col gap-1">
        <label class="text-sm px-4">{{ form.bond_price.label }}:</label>
        <input name="{{ form.bond_price.name }}" value="{{ form.bond_price.value|default:'' }}"
               type="text" placeholder="{{ form.bond_price.label }}"
               class="border border-[var(--text)] rounded-md px-4 py-2 focus:outline-none">
              {% if form.bond_price.errors %}<div class="text-sm text-red-600">{{ form.bond_price.errors|join:", " }}</div>{% endif %}
      </div>

      <div class="flex flex-col gap-1">
        <label class="text-sm px-4">{{ form.issue_volume.label }}:</label>
        <input name="{{ form.issue_volume.name }}" value="{{ form.issue_volume.value|default:'' }}"
               type="text" placeholder="{{ form.issue_volume.label }}"
               class="border border-[var(--text)] rounded-md px-4 py-2 focus:outline-none">
            {% if form.issue_volume.errors %}<div class="text-sm text-red-600">{{ form.issue_volume.errors|join:", " }}</div>{% endif %}
      </div>

      <div class="flex flex-col gap-1">
        <label class="text-sm px-4">{{ form.term_months.label }}:</label>
        <input name="{{ form.term_months.name }}" value="{{ form.term_months.value|default:'' }}"
               type="number" min="0" step="1" placeholder="{{ form.term_months.label }}"
               class="border border-[var(--text)] rounded-md px-4 py-2 focus:outline-none">
        {% if form.term_months.errors %}<div class="text-sm text-red-600">{{ form.term_months.errors|join:", " }}</div>{% endif %}
      </div>
    </div>
  </div>

  <div class="bg-white border border-[var(--accent)] rounded-md px-7 py-5">
    <div class="text-xl mb-4">Dateien</div>

    {% if attachments %}
      <div class="bg-gray-50 border-2 border-white rounded-md overflow-hidden mb-6">
        <div class="divide-y-4 divide-white">
          {% for a in attachments %}
            <div class="grid grid-cols-12 items-center px-4 py-3 gap-4">
              <div class="col-span-5">
                <a class="underline hover:text-[var(--accent)] transition"
                   href="{{ a.att.file.url }}" target="_blank">
                  {{ a.filename }}
                </a>
              </div>

              <div class="col-span-6">
                <input
                  name="att_desc_{{ a.att.id }}"
                  value="{{ a.att.description|default:'' }}"
                  type="text"
                  placeholder="Beschreibung"
                  class="w-full border border-[var(--text)] rounded-md px-4 py-2 focus:outline-none bg-white"
                >
              </div>

              <div class="col-span-1 flex items-center justify-end">
                <label class="text-sm flex items-center gap-2">
                  <input type="checkbox" name="att_del_{{ a.att.id }}" value="1">
                  Löschen
                </label>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    <div class="bg-white border border-[var(--accent)] rounded-md px-7 py-5 overflow-hidden">
      <div id="new-files" class="divide-y-4 divide-white">
        <div class="grid grid-cols-12 items-center px-4 py-3 gap-4">
          <div class="col-span-5">
            <input
              type="file"
              name="new_file"
              class="w-full border border-[var(--text)] rounded-md px-4 py-2 focus:outline-none bg-white"
            >
          </div>

          <div class="col-span-6">
            <input
              type="text"
              name="new_desc"
              placeholder="Beschreibung"
              class="w-full border border-[var(--text)] rounded-md px-4 py-2 focus:outline-none bg-white"
            >
          </div>

          <div class="col-span-1 flex items-center justify-end">
            <button
              type="button"
              class="underline hover:text-[var(--accent)] transition"
              onclick="addNewFileRow()"
            >
              + Datei
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    function addNewFileRow() {
      const wrap = document.getElementById("new-files");
      const row = document.createElement("div");
      row.className = "grid grid-cols-12 items-center px-4 py-3 gap-4";
      row.innerHTML = `
        <div class="col-span-5">
          <input type="file" name="new_file"
            class="w-full border border-[var(--text)] rounded-md px-4 py-2 focus:outline-none bg-white">
        </div>

        <div class="col-span-6">
          <input type="text" name="new_desc" placeholder="Beschreibung"
            class="w-full border border-[var(--text)] rounded-md px-4 py-2 focus:outline-none bg-white">
        </div>

        <div class="col-span-1 flex items-center justify-end">
          <button type="button"
            class="underline hover:text-red-600 transition"
            onclick="this.closest('.grid').remove()">
            Entfernen
          </button>
        </div>
      `;
      wrap.appendChild(row);
    }
  </script>

  <div class="bg-white border border-[var(--text)] rounded-md p-6">
    <div class="text-xl mb-4">Vertrag (Texte)</div>

    <div class="flex flex-col gap-4">
      {% for field in form %}
        {% if field.name|slice:":10" == "contract__" %}
          <div class="flex flex-col gap-1">
            <label class="text-sm px-4">{{ field.label }}:</label>
            <textarea name="{{ field.name }}"
                      class="border border-[var(--text)] rounded-md px-4 py-2 focus:outline-none"
                      rows="{{ field.field.widget.attrs.rows|default:4 }}">{{ field.value|default:'' }}</textarea>
            {% if field.errors %}<div class="text-sm text-red-600">{{ field.errors|join:", " }}</div>{% endif %}
          </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>

  <div class="flex justify-end gap-6">
    <button type="submit"
            class="w-48 rounded-md bg-[var(--accent)] text-white py-3 hover:brightness-110 transition font-semibold text-center">
      Speichern
    </button>

    <a href="{% url 'panel_admin_issues_list' %}"
       class="w-48 rounded-md bg-gray-50 border-2 border-white text-[var(--text)] py-3 hover:brightness-95 transition font-semibold text-center flex items-center justify-center">
      Abbrechen
    </a>
  </div>
</form>

{% endblock %}
